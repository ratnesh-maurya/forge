# Egress Security

Forge provides build-time egress security controls that restrict which external domains a containerized agent can access. Egress configuration generates allowlist artifacts and Kubernetes NetworkPolicy manifests.

## Overview

Egress security operates at **build time only** — it generates configuration files that are enforced by the container runtime (Kubernetes NetworkPolicy). There is no runtime egress guard in the agent process itself.

The system resolves allowed domains from three sources:
1. **Explicit domains** — Listed in `forge.yaml`
2. **Tool domains** — Inferred from registered tools
3. **Capability bundles** — Pre-defined domain sets for common services

## Profiles

Profiles set the overall security posture. Defined in `internal/security/egress/types.go`:

| Profile | Description | Default Mode |
|---------|-------------|-------------|
| `strict` | Maximum restriction, deny by default | `deny-all` |
| `standard` | Balanced, allow known domains | `allowlist` |
| `permissive` | Minimal restriction for development | `dev-open` |

Default profile: `strict`. Default mode: `deny-all`.

## Modes

Modes control egress behavior within a profile:

| Mode | Behavior |
|------|----------|
| `deny-all` | No outbound network access |
| `allowlist` | Only explicitly allowed domains |
| `dev-open` | Unrestricted outbound access (development only) |

## Capability Bundles

Capability bundles (`internal/security/egress/capabilities.go`) map service names to their required domains:

| Capability | Domains |
|-----------|---------|
| `slack` | `slack.com`, `hooks.slack.com`, `api.slack.com` |
| `telegram` | `api.telegram.org` |

Specify capabilities in `forge.yaml` to automatically include their domains.

## Tool Domain Inference

The tool domain inference system (`internal/security/egress/tool_domains.go`) maps tool names to known required domains:

| Tool | Inferred Domains |
|------|-----------------|
| `web_search` | `api.perplexity.ai` |
| `github_api` | `api.github.com`, `github.com` |
| `slack_notify` | `slack.com`, `hooks.slack.com` |
| `openai_completion` | `api.openai.com` |
| `anthropic_api` | `api.anthropic.com` |
| `huggingface_api` | `api-inference.huggingface.co`, `huggingface.co` |
| `sendgrid_email` | `api.sendgrid.com` |
| `twilio_sms` | `api.twilio.com` |
| `aws_bedrock` | `bedrock-runtime.us-east-1.amazonaws.com` |
| `azure_openai` | `openai.azure.com` |

## Allowlist Resolution

The resolver (`internal/security/egress/resolver.go`) combines all domain sources:

1. Validate profile and mode
2. For `deny-all`: return empty config
3. For `dev-open`: return unrestricted config
4. For `allowlist`:
   - Start with explicit domains from `forge.yaml`
   - Add tool-inferred domains
   - Add capability bundle domains
   - Deduplicate and sort

## Build Artifacts

The `EgressStage` (`internal/build/egress_stage.go`) generates:

### `egress_allowlist.json`

```json
{
  "profile": "standard",
  "mode": "allowlist",
  "allowed_domains": ["api.example.com"],
  "tool_domains": ["googleapis.com"],
  "all_domains": ["api.example.com", "googleapis.com"]
}
```

Empty arrays are always `[]`, never `null`.

### Kubernetes `network-policy.yaml`

Generated by `GenerateK8sNetworkPolicy()` in `internal/security/egress/network_policy.go`:

- **deny-all**: Empty egress rules (`egress: []`)
- **allowlist**: Allows ports 80/443 with domain annotations
- **dev-open**: Allows ports 80/443 without restrictions

The NetworkPolicy uses pod selector `app: <agent-id>` and includes domain annotations for external DNS-based policy controllers.

## Configuration

In `forge.yaml`:

```yaml
egress:
  profile: standard
  mode: allowlist
  allowed_domains:
    - api.example.com
    - hooks.slack.com
  capabilities:
    - slack
    - telegram
```

## Production vs Development

| Setting | Production | Development |
|---------|-----------|-------------|
| Profile | `strict` or `standard` | `permissive` |
| Mode | `deny-all` or `allowlist` | `dev-open` |
| Dev tools | Filtered out | Included |
| Network policy | Enforced | Not generated |

## Related Files

- `internal/security/egress/types.go` — Profile and mode types
- `internal/security/egress/resolver.go` — Allowlist resolution logic
- `internal/security/egress/capabilities.go` — Capability bundle definitions
- `internal/security/egress/tool_domains.go` — Tool domain inference
- `internal/security/egress/allowlist.go` — JSON allowlist generation
- `internal/security/egress/network_policy.go` — K8s NetworkPolicy generation
- `internal/build/egress_stage.go` — Build pipeline integration
