"""
A2A-compliant HTTP wrapper for CrewAI agents.
Auto-generated by Forge â€” do not edit manually.
"""
import json
import os
import sys
import uuid
from http.server import HTTPServer, BaseHTTPRequestHandler

# Ensure the project root is importable
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from agent import create_agent, create_crew  # noqa: E402

AGENT_NAME = "{{.Name}}"
AGENT_DESCRIPTION = "{{.Description}}"
SKILLS = [
{{- range .Tools}}
    {"id": "{{.Name}}", "name": "{{.Name}}", "description": "{{.Description}}"},
{{- end}}
]


def build_agent_card():
    return {
        "name": AGENT_NAME,
        "description": AGENT_DESCRIPTION,
        "url": f"http://localhost:{os.environ.get('PORT', '8080')}",
        "skills": SKILLS,
        "capabilities": {
            "streaming": False,
            "pushNotifications": False,
            "stateTransitionHistory": False,
        },
    }


class A2AHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        """Return agent card at root."""
        if self.path == "/" or self.path == "/.well-known/agent.json":
            card = build_agent_card()
            payload = json.dumps(card).encode()
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.send_header("Content-Length", str(len(payload)))
            self.end_headers()
            self.wfile.write(payload)
        else:
            self.send_error(404)

    def do_POST(self):
        """Handle A2A task requests."""
        try:
            length = int(self.headers.get("Content-Length", 0))
            body = json.loads(self.rfile.read(length)) if length else {}

            # Extract input text from A2A message
            input_text = ""
            params = body.get("params", {})
            message = params.get("message", {})
            parts = message.get("parts", [])
            for part in parts:
                if part.get("kind") == "text":
                    input_text = part.get("text", "")
                    break

            task_id = params.get("id", str(uuid.uuid4()))

            # Run CrewAI crew
            crew = create_crew()
            result = crew.kickoff(inputs={"input": input_text})

            response = {
                "jsonrpc": "2.0",
                "id": body.get("id"),
                "result": {
                    "id": task_id,
                    "status": {"state": "completed"},
                    "artifacts": [
                        {
                            "parts": [{"kind": "text", "text": str(result)}]
                        }
                    ],
                },
            }
        except Exception as exc:
            response = {
                "jsonrpc": "2.0",
                "id": body.get("id") if "body" in dir() else None,
                "result": {
                    "id": task_id if "task_id" in dir() else str(uuid.uuid4()),
                    "status": {
                        "state": "failed",
                        "message": {"role": "agent", "parts": [{"kind": "text", "text": str(exc)}]},
                    },
                },
            }

        payload = json.dumps(response).encode()
        self.send_response(200)
        self.send_header("Content-Type", "application/json")
        self.send_header("Content-Length", str(len(payload)))
        self.end_headers()
        self.wfile.write(payload)

    def log_message(self, fmt, *args):
        print(f"[A2A] {fmt % args}")


def main():
    port = int(os.environ.get("PORT", "8080"))
    server = HTTPServer(("0.0.0.0", port), A2AHandler)
    print(f"CrewAI A2A wrapper listening on port {port}")
    server.serve_forever()


if __name__ == "__main__":
    main()
